{% extends "base.html" %}
{% block title %}{{ query }}{% endblock %}

{% block content %}
{% load filter_tags %}
{% load search_engine_tags %}

<div class="row">
<div class="col-md-4">

<form class="form">

<a class="btn btn-sm btn-primary" role="button" data-toggle="collapse" href="#mappingFilters" aria-expanded="false" aria-controls="mappingFilters">
  Advanced filters
</a>
<button type="submit" class="btn btn-sm btn-success">Filter <i class="fa fa-filter"></i></button></span></button>
 <input type="hidden" name="query" value="{{ query }}">
 <input type="hidden" name="idx" value="{{ idx_name }}">
</div>
</div>

<div class="row">
<div class="col-md-4">
<br/>

<!-- Aggregation filters -->
{% for agg, agg_value in aggs.items|sort %}
  {% if agg_value.get_buckets %}
	<div class="panel panel-info">
	<div class="panel-heading"><h4 class="panel-title">{{ agg }}</h4></div>
	<div class="panel-body">
	{% for bucket in agg_value.get_buckets|sort %}
		<div class="checkbox"><label>
		<input type="checkbox" name="{{ agg }}" value="{{ bucket.key }}" checked>{{ bucket.key }}
		<span class="badge">{{ bucket.doc_count }}</span></label></div>
	{% endfor %}
	</div>
	</div>
  {% endif %}
{% endfor %}

<!-- Mapping filters -->
<div class="collapse" id="mappingFilters">
{% for idx, idxmap in mappings.items|sort %}
	<div class="panel panel-info">
	<div class="panel-heading"><h4 class="panel-title">{{ idx }}</h4></div>
	<div class="panel-body">
	{% for type, values in idxmap.mappings.items|sort %}
		{% if idxmap.mappings|length > 1 %}<strong>{{ type }}</strong>{% endif %}
		{% for para, para_type in values.properties.items|sort %}
		    {% if para_type.properties %}
		    	<div class="panel panel-default">
		        <div class="panel-body">
		        <div>{{ para }}:</div>
		    	{% for subpara, subpara_type in para_type.properties.items|sort %}
		    			<div class="checkbox"><label>
		    			<input type="checkbox" name="{{ type }}_{{ para }}_{{ subpara }}" value="{{ type }}:{{ para }}:{{ subpara }}"
		    				{% if para.subpara in fields or para|add:"."|add:subpara in fields %}checked{% endif %}>{{ subpara }}</label></div>
		    	{% endfor %}
		    	</div></div>
		    {% elif "string" == para_type.type %}
		        <div class="checkbox">
		    		<label><input type="checkbox" name="{{ type }}_{{ para }}" value="{{ type }}:{{ para }}" 
		    			{% if para in fields %}checked{% endif %}>{{ para }}</label>
		    	</div>
	        {% endif %}
		{% endfor %}
	{% endfor %}
	</div></div>
{% endfor %}
</div>

</form>
</div>

<!-- Hits -->
<div class="col-md-8">
{{ data|length }} of {{ hits_total }} hit(s) for '{{ query }}':

{% for doc in data %}
	<div class="panel panel-default">
  	<div class="panel-body">
  	<span class="badge">{{ doc|doc_type }}</span><br/>
	{% for key in doc|doc_keys %}
		{% if key != "_meta" %}
		    {{ key }}:
			{{ doc|doc_attr:key }};
		{% endif %}
	{% endfor %}
	<br/><br/>Matches: <br/>
	
	{% with '<strong> </strong> <br/>' as tags %}
	{% for html_fragment in doc|doc_highlight %}
	   {% if html_fragment in tags.split %}
{{ html_fragment.strip|safe }}
	   {% else %}
{{ html_fragment }}
	   {% endif %}
	{% endfor %}
	{% endwith %}
	<br/>
	{% if doc|doc_type == 'gene' %}
	   <a href="/gene/?g={{ doc|doc_id }}">Gene Page</a><br/>
	{% endif %}
	<a href="{{ doc|doc_link|safe }}" target="_blank">document</a>
	</div>
	</div>
{% endfor %}
</div>
</div>

{% endblock %}
